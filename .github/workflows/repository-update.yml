name: Repository update (admin)
on:
#  repository_dispatch:
#    types: ["Repository update"]
  schedule:
    - cron: "00 3 * * *"
  workflow_dispatch:
    inputs:
      BUILD_BRANCH:
        description: Build branch
        required: false
        default: main
        type: string
      BUILD_RUNNER:
        description: Build runner
        required: false
        default: ubuntu-latest
        type: string
      TARGET_REPOSITORY:
        type: choice
        description: Select repository
        options:
        - beta.armbian.com
        - apt.armbian.com
      UPDATE_REPOSITORY:
        type: boolean
        description: Update repository
        default: true

concurrency:
  group: repository-${{ github.ref }}
  cancel-in-progress: false

jobs:

  gradle:
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        repository: ["repository-beta","repository"]
    
    name: rerun
    runs-on: repository
    steps:

      - name: "Sync ${{ matrix.repository }}"
        run: |

          # install dependencies
          if ! command -v "lftp" > /dev/null 2>&1; then
             sudo apt-get -y -qq install lftp
          fi

          upload artifacts
          lftp -u upload, -e "set net:timeout 4;set net:max-retries 6;mirror -R --parallel=8 --no-perms /outgoing/${{ matrix.repository }}/public/ ;bye" sftp://${{ env.ARMBIAN_HOST_UPLOAD }}
    
      #- name: "Prepare for ${{ matrix.repository }}"
      #  run: |
      #   tree /incoming/${{ matrix.repository }}

      #- name: Checkout build repository
      #  uses: actions/checkout@v3
      #  with:
      #    repository: armbian/build
      #    fetch-depth: 1
      #    clean: false

      #- name: Import GPG key
      #  uses: crazy-max/ghaction-import-gpg@v5
      #  with:
      #    gpg_private_key: ${{ secrets.GPG_KEY1 }}
      #    passphrase: ${{ secrets.GPG_PASSPHRASE1 }}

      #- name: "Build repository ${{ matrix.repository }}"
      #  run: |
      #  
      #    sed -i 's|"gpgProvider": ".*"|"gpgProvider": "gpg2"|g' tools/repository/aptly.conf
      #   tools/repository/repo -i /incoming/${{ matrix.repository }} -o /outgoing/${{ matrix.repository }} -c update -p ${{ secrets.GPG_PASSPHRASE1 }}
