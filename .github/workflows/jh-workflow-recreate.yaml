name: "JH Workflow Recreate"

on:
  schedule:
    - cron: '0 3 * * 1'  # Weekly on Monday at 3 AM UTC
  push:
    branches:
      - 'main'
    paths:
      - "userpatches-jethub/gha/**"
      - "userpatches-jethub/gha/chunks/**"
      - "userpatches-jethub/targets-*.yaml"
      - ".github/workflows/jh-workflow-recreate.yaml"
  workflow_dispatch:
    inputs:
      force_pr:
        description: 'Force create PR even without changes'
        required: false
        type: boolean
        default: false

concurrency:
  group: workflow-recreate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  recreate-workflows:
    name: "Recreate JH Workflows"
    if: ${{ github.repository_owner == 'jethome-iot' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout armbian-build repository
        uses: actions/checkout@v6
        with:
          repository: jethome-iot/armbian-build
          ref: main-jethub
          fetch-depth: 1
          clean: false
          path: build

      - name: Checkout armbian-os repository
        uses: actions/checkout@v6
        with:
          repository: jethome-iot/armbian-os
          ref: main
          fetch-depth: 0
          clean: false
          path: os
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          cd os
          git config user.name "JetHome Dev Bot"
          git config user.email "dev@jethome.ru"

      - name: Sync userpatches to build directory
        run: |
          rsync -av os/userpatches-jethub/. build/userpatches/

      - name: Generate STABLE workflow
        run: |
          cd build
          cp userpatches/gha/gha_config_release.yaml userpatches/gha/gha_config.yaml
          cp userpatches/targets-stable.yaml userpatches/targets.yaml
          bash ./compile.sh gha-template

          # Copy generated workflow
          cp output/info/artifact-image-complete-matrix.yml \
             ../os/.github/workflows/jh-stable-artifact-image-complete-matrix.yml

          echo "âœ… STABLE workflow generated"

      - name: Generate NIGHTLY workflow
        run: |
          cd build
          cp userpatches/gha/gha_config_nightly.yaml userpatches/gha/gha_config.yaml
          cp userpatches/targets-full.yaml userpatches/targets.yaml
          bash ./compile.sh gha-template

          # Copy generated workflow
          cp output/info/artifact-image-complete-matrix.yml \
             ../os/.github/workflows/jh-nightly-artifact-image-complete-matrix.yml

          echo "âœ… NIGHTLY workflow generated"

      - name: Check for changes
        id: check-changes
        run: |
          cd os
          if git diff --quiet .github/workflows/jh-stable-artifact-image-complete-matrix.yml \
                               .github/workflows/jh-nightly-artifact-image-complete-matrix.yml; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected in workflows"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in workflows"
            
            # Show what changed
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "STABLE workflow changes:"
            git diff --stat .github/workflows/jh-stable-artifact-image-complete-matrix.yml || true
            echo ""
            echo "NIGHTLY workflow changes:"
            git diff --stat .github/workflows/jh-nightly-artifact-image-complete-matrix.yml || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: Create/Update Pull Request
        if: ${{ steps.check-changes.outputs.has_changes == 'true' || github.event.inputs.force_pr == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd os
          
          # Checkout or create feature branch
          BRANCH_NAME="automated/update-gha-workflows-$(date +%Y%m%d)"
          
          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "â„¹ï¸  Branch $BRANCH_NAME already exists, checking out..."
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME"
          else
            echo "âœ… Creating new branch $BRANCH_NAME..."
            git checkout -b "$BRANCH_NAME"
          fi
          
          # Add and commit changes
          git add .github/workflows/jh-stable-artifact-image-complete-matrix.yml
          git add .github/workflows/jh-nightly-artifact-image-complete-matrix.yml
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸  No staged changes to commit"
          else
            # Create commit message with details
            cat > /tmp/commit-msg.txt << 'COMMIT_MSG'
          feat(ci): regenerate JH workflows from templates

          Automatically regenerated GitHub Actions workflows:
          - jh-stable-artifact-image-complete-matrix.yml
          - jh-nightly-artifact-image-complete-matrix.yml

          Changes:
          - Updated GitHub Actions to latest versions
          - Regenerated from gha_config_release.yaml and gha_config_nightly.yaml
          - Applied latest template changes from userpatches-jethub/gha/chunks/

          Generated by: .github/workflows/jh-workflow-recreate.yaml
          COMMIT_MSG
            
            git commit -F /tmp/commit-msg.txt
            echo "âœ… Changes committed"
          fi
          
          # Push branch
          git push origin "$BRANCH_NAME" --force-with-lease
          echo "âœ… Branch pushed: $BRANCH_NAME"
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "â„¹ï¸  PR already exists: #$EXISTING_PR"
            echo "Updating PR..."
            
            # Update PR body
            cat > /tmp/pr-body.md << 'PR_BODY'
          ## ðŸ¤– ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ workflow Ñ„Ð°Ð¹Ð»Ñ‹

          Ð­Ñ‚Ð¾Ñ‚ PR Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ GitHub Actions workflows, ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð².

          ### ðŸ“‹ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

          - âœ… **STABLE workflow**: `jh-stable-artifact-image-complete-matrix.yml`
          - âœ… **NIGHTLY workflow**: `jh-nightly-artifact-image-complete-matrix.yml`

          ### ðŸ”„ Ð§Ñ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾

          - GitHub Actions Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
          - Ð ÐµÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹:
            - `userpatches-jethub/gha/gha_config_release.yaml` (stable)
            - `userpatches-jethub/gha/gha_config_nightly.yaml` (nightly)
          - ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² `userpatches-jethub/gha/chunks/`

          ### ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

          Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ workflows Ð¿ÐµÑ€ÐµÐ´ Ð¼ÐµÑ€Ð´Ð¶ÐµÐ¼:

          ```bash
          # Ð¢ÐµÑÑ‚ stable workflow
          gh workflow run "JH Stable Build Artifacts and Images" \
            --ref $BRANCH_NAME \
            --field board=jethubj100 \
            --field skipImages=yes \
            --field checkOci=yes

          # Ð¢ÐµÑÑ‚ nightly workflow
          gh workflow run "JH Nightly Build Artifacts and Images" \
            --ref $BRANCH_NAME \
            --field board=jethubj100 \
            --field skipImages=yes \
            --field checkOci=yes
          ```

          ### ðŸ“Š Ð’ÐµÑ€ÑÐ¸Ð¸ GitHub Actions

          - `actions/checkout`: v6
          - `actions/upload-artifact`: v5
          - `actions/download-artifact`: v6
          - `actions/cache`: v4

          ---

          ðŸ¤– _ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾ workflow: `.github/workflows/jh-workflow-recreate.yaml`_
          PR_BODY
            
            gh pr edit "$EXISTING_PR" --body-file /tmp/pr-body.md
            echo "âœ… PR #$EXISTING_PR updated"
          else
            echo "Creating new PR..."
            
            # Create PR
            cat > /tmp/pr-body.md << 'PR_BODY'
          ## ðŸ¤– ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ workflow Ñ„Ð°Ð¹Ð»Ñ‹

          Ð­Ñ‚Ð¾Ñ‚ PR Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ GitHub Actions workflows, ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð².

          ### ðŸ“‹ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

          - âœ… **STABLE workflow**: `jh-stable-artifact-image-complete-matrix.yml`
          - âœ… **NIGHTLY workflow**: `jh-nightly-artifact-image-complete-matrix.yml`

          ### ðŸ”„ Ð§Ñ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾

          - GitHub Actions Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
          - Ð ÐµÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹:
            - `userpatches-jethub/gha/gha_config_release.yaml` (stable)
            - `userpatches-jethub/gha/gha_config_nightly.yaml` (nightly)
          - ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² `userpatches-jethub/gha/chunks/`

          ### ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

          Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ workflows Ð¿ÐµÑ€ÐµÐ´ Ð¼ÐµÑ€Ð´Ð¶ÐµÐ¼:

          ```bash
          # Ð¢ÐµÑÑ‚ stable workflow
          gh workflow run "JH Stable Build Artifacts and Images" \
            --ref $BRANCH_NAME \
            --field board=jethubj100 \
            --field skipImages=yes \
            --field checkOci=yes

          # Ð¢ÐµÑÑ‚ nightly workflow
          gh workflow run "JH Nightly Build Artifacts and Images" \
            --ref $BRANCH_NAME \
            --field board=jethubj100 \
            --field skipImages=yes \
            --field checkOci=yes
          ```

          ### ðŸ“Š Ð’ÐµÑ€ÑÐ¸Ð¸ GitHub Actions

          - `actions/checkout`: v6
          - `actions/upload-artifact`: v5
          - `actions/download-artifact`: v6
          - `actions/cache`: v4

          ---

          ðŸ¤– _ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾ workflow: `.github/workflows/jh-workflow-recreate.yaml`_
          PR_BODY
            
            PR_URL=$(gh pr create \
              --title "feat(ci): regenerate JH workflows from templates" \
              --body-file /tmp/pr-body.md \
              --head "$BRANCH_NAME" \
              --base main \
              --label "automated" \
              --label "ci" \
              2>&1)
            
            echo "âœ… PR created: $PR_URL"
          fi

      - name: Summary
        if: always()
        run: |
          cd os
          echo "## ðŸ“Š Workflow Regeneration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **STABLE workflow**: regenerated from \`gha_config_release.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- **NIGHTLY workflow**: regenerated from \`gha_config_nightly.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected**: ${{ steps.check-changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "### âœ… Pull Request Created/Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the PR and test workflows before merging." >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸  No Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Workflows are up to date with templates." >> $GITHUB_STEP_SUMMARY
          fi

